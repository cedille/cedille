\documentclass{article}

\usepackage{amsmath,amssymb,amsthm}
\usepackage{url}
\usepackage{comment}
\usepackage{proof}
\usepackage{stmaryrd}
\usepackage{parskip}
\usepackage{fullpage}

\newcommand{\choice}[0]{\zeta}
\newcommand{\elcap}[0]{\cap}
\newcommand{\abs}[4]{{#1}\, #2\! : \! #3.\, #4}
\newcommand{\absu}[3]{{#1}\, #2.\, #3}
\mathchardef\mhyph="2D % Define a "math hyphen"
\newcommand{\interp}[1]{\llbracket #1 \rrbracket} 
\newcommand{\tpcheck}[0]{\Leftarrow}
\newcommand{\tpsynth}[0]{\Rightarrow}
\newcommand{\cbe}[0]{c\beta\eta}
\newcommand{\utp}[0]{\mathcal{U}}
\newcommand{\startcase}[1]{\vspace{#1} \noindent\textbf{\underline{Case:}}}

\newtheorem{theorem}{Theorem}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{observation}[theorem]{Observation}

\begin{document}

\title{Syntax and Semantics of Cedille}

\author{Aaron Stump, Christa Jenkins \\
  Computer Science \\
  The University of Iowa \\
\texttt{aaron-stump@uiowa.edu}, \texttt{christa-jenkins@uiowa.edu}}

\date{}

\maketitle

\section{Introduction}

The type theory of Cedille is called the Calculus of Dependent Lambda
Eliminations (CDLE).  This document presents the version of CDLE as of
June 1, 2018.  We have made many changes from the first paper on CDLE~\cite{stump17},
mostly in the form of dropping constructs we discovered (to our
surprise) could be derived~\cite{stump18}. I have also omitted
\emph{lifting} -- a technique for large eliminations with lambda
encodings -- in this document's version of CDLE.  Some uses of lifting
can be simulated other ways within the system, though the limits of
this are still under investigation.  We also include a construct
$\delta$, for deriving a contradiction from a proof that
lambda-encoded true equals lambda-encoded false.  This also
compensates somewhat for the lack of lifting.

At a high level, CDLE is an extrinsic (i.e., Curry-style) type theory
extending the Calculus of Constructions with three additional
constructs, which allow deriving induction principles within the
theory, for inductive datatypes.  The goal is to support usual
idioms of dependently typed programming and proving as in Agda or
similar tools, but using pure lambda encodings for all data, and
requiring a much smaller core theory.

The current Cedille implementation of CDLE extends the system
described below with a number of features intended to make programming
in the system more convenient and with less redundancy.  These
features all compile away to a slightly simplified version of the
theory presented in this document, called Cedille Core, described
here: \url{https://github.com/astump/cedille-core-spec}.

\section{Classification Rules}

The classification rules are given in
Figures~\ref{fig:superknd},~\ref{fig:knd}, and~\ref{fig:tp}.  For
brevity, we take these figures as implicitly specifying the syntax of
kinds $\kappa$, types $T$, and annotated terms $t$; these may use term
variables $x$ and type variables $X$, which we assume come from
distinct sets.  So terms and types are syntactically distinguished.
The typing rules (Figure~\ref{fig:tp}) are
bidirectional~\cite{pierce+00}, while the kinding and superkinding
rules (Figure~\ref{fig:knd} and~\ref{fig:superknd}) are only
synthesizing.  We write $\Leftrightarrow$ to range over
$\{\tpcheck,\tpsynth\}$. We follow the syntax of our implementation
Cedille, which distinguishes application of a term or type $e$ to a
type ($e \cdot T$), from application to a term ($e\ t$), and
application to an erased term argument ($e\ \mhyph t$).  The rules are
intended, with a few points of nondeterminism, to be read bottom-up
(in a standard way; cf.~\cite{peytonjones07}) as an algorithm for
computing a classifier from a context and an expression ($\tpsynth$)
or checking an expression against a classifier in context
($\tpcheck$).

The classification rules refer to an erasure function, defined in
Figure~\ref{fig:eraser}.  The type theory is \emph{extrinsic} (aka,
Curry-style), and hence we only consider erasures $|t|$ of terms when
testing for $\beta\eta$-equivalence.  This is done by the conversion
relation $T\cong T'$, whose central rules are given in
Figure~\ref{fig:conv}.  That figure omits the various congruence rules
needed to equate bigger expressions by equating subexpressions.  The
main ideas of conversion shown in the figure are to use
$\beta$-equivalence at the type level, and $\beta\eta$-equivalence of
erased terms at the term level.


\begin{figure}
  \[
  \begin{array}{llll}
    \infer{\Gamma \vdash \star}{\ } &
    \infer{\Gamma\vdash\abs{\Pi}{x}{T}{\kappa}}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash\kappa} &
    \infer{\Gamma\vdash\abs{\Pi}{X}{\kappa'}{\kappa}}{\Gamma \vdash \kappa' & \Gamma,X:\kappa'\vdash\kappa}
  \end{array}
  \]
  \caption{Rules for checking that a kind is well-formed ($\Gamma \vdash \kappa$)}
  \label{fig:superknd}
\end{figure}

\begin{figure}
  \[
  \begin{array}{ll}
    \infer{\Gamma \vdash X \tpsynth \kappa}{(X : \kappa) \in \Gamma} &
    \infer{\Gamma\vdash \abs{\forall}{X}{\kappa}{T} \tpsynth \star}{\Gamma \vdash \kappa & \Gamma,X:\kappa\vdash T \tpsynth \star} \\ \\
    \infer{\Gamma\vdash\abs{\forall}{x}{T}{T'} \tpsynth \star}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash T' \tpsynth \star} &
    \infer{\Gamma\vdash\abs{\Pi}{x}{T}{T'} \tpsynth \star}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash T' \tpsynth \star} \\ \\
    \infer{\Gamma\vdash\abs{\lambda}{x}{T}{T'} \tpsynth \abs{\Pi}{x}{T}{\kappa}}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash T'\tpsynth\kappa} &
    \infer{\Gamma\vdash\abs{\lambda}{X}{\kappa}{T'} \tpsynth \abs{\Pi}{X}{\kappa}{\kappa'}}{\Gamma \vdash \kappa & \Gamma,X:\kappa\vdash T'\tpsynth\kappa'} \\ \\
    \infer{\Gamma\vdash T\ t \tpsynth [t/x]\kappa}{\Gamma\vdash T \tpsynth \abs{\Pi}{x}{T'}{\kappa} & \Gamma\vdash t \tpcheck T'} &
    \infer{\Gamma\vdash T\cdot T' \tpsynth [T'/X]\kappa}{\Gamma\vdash T \tpsynth \abs{\Pi}{X}{\kappa'}{\kappa} & \Gamma\vdash T' \tpsynth \kappa' & \kappa \cong \kappa'} \\ \\
    \infer{\Gamma\vdash\abs{\iota}{x}{T}{T'} \tpsynth \star}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash T' \tpsynth \star} &
    \infer{\Gamma\vdash \{ t \simeq t' \} : \star}{\textit{FV}(t\ t')\subseteq\textit{dom}(\Gamma)}
  \end{array}
  \]
  \caption{Rules for synthesizing a kind for a type ($\Gamma \vdash T \tpsynth \kappa$)}
  \label{fig:knd}
\end{figure}


\begin{figure}
  \[
  \begin{array}{ll}
    \infer{\Gamma\vdash x\tpsynth T}{(x : t)\in\Gamma} &
    \infer{\Gamma\vdash t\tpcheck T'}{\Gamma\vdash t \tpcheck T & T' \leadsto^*_\beta T} \\ \\    
    \infer{\Gamma\vdash t\tpsynth T'}{\Gamma\vdash t \tpsynth T & T \leadsto^*_\beta T'} &
    \infer{\Gamma\vdash t\tpcheck T}{\Gamma\vdash t\tpsynth T' & T' \cong T} \\ \\    
    \infer{\Gamma\vdash \absu{\lambda}{x}{t} \tpcheck \abs{\Pi}{x}{T}{T'}}{\Gamma,x:T\vdash t\tpcheck T'} &
    \infer{\Gamma\vdash t\ t' \tpsynth [t'/x]T}{\Gamma\vdash t \tpsynth \abs{\Pi}{x}{T'}{T} & \Gamma\vdash t' \tpcheck T'} \\ \\

    \infer{\Gamma\vdash \absu{\Lambda}{X}{t} \tpcheck \abs{\forall}{X}{\kappa}{T}}{\Gamma,X:\kappa\vdash t \tpcheck T} &
    \infer{\Gamma\vdash t \cdot T' \tpsynth [T'/X]T}
          {\Gamma\vdash t \tpsynth \abs{\forall}{X}{\kappa}{T} & \Gamma\vdash T' \tpcheck\kappa} \\ \\

    \infer{\Gamma\vdash \absu{\Lambda}{x}{t} \tpcheck \abs{\forall}{x}{T'}{T}}{\Gamma,x:T'\vdash t \tpcheck T & x\not\in\textit{FV}(|t|)} &
    \infer{\Gamma\vdash t\ \mhyph t' \tpsynth [t'/x]T}{\Gamma\vdash t \tpsynth \abs{\forall}{x}{T'}{T} & \Gamma\vdash t' \tpcheck T'} \\ \\

    \infer{\Gamma\vdash [ t , t' ] \tpcheck \abs{\iota}{x}{T}{T'}}
          {\Gamma\vdash t \tpcheck T & \Gamma\vdash t' \tpcheck [t/x]T' & |t| =_{\beta\eta} |t'|} &
    \infer{\Gamma\vdash t.1 \tpsynth T}{\Gamma\vdash t \tpsynth \abs{\iota}{x}{T}{T'}} \\ \\
    \infer{\Gamma\vdash t.2 \tpsynth [t.1/x]T'}{\Gamma\vdash t \tpsynth \abs{\iota}{x}{T}{T'}} &

    \infer{\Gamma\vdash \beta\{t'\} \tpcheck \{ t \simeq t \}}{\Gamma\vdash \textit{FV}(t)\subseteq \textit{dom}(\Gamma)}  \\ \\    
    \infer{\Gamma\vdash \delta\ \mhyph\ t \tpcheck T}{\Gamma\vdash t\tpcheck \{ \absu{\lambda}{x}{\absu{\lambda}{y}{x}} \simeq \absu{\lambda}{x}{\absu{\lambda}{y}{y}}\}}  &
    \infer{\Gamma\vdash \rho\ t'\ \mhyph\ t \Leftrightarrow [t_2/x]T}
          {\Gamma\vdash t' \tpsynth \{ t_1 \simeq t_2 \} & \Gamma \vdash t \Leftrightarrow [t_1/x]T} \\ \\
    \infer{\Gamma\vdash \chi\ T\ \mhyph\ t \tpcheck T'}
          {\Gamma\vdash T\tpcheck \star & \Gamma\vdash t \tpcheck T & T \cong T'} &
    \infer{\Gamma\vdash \chi\ T\ \mhyph\ t \tpsynth T}
          {\Gamma\vdash T\tpcheck \star & \Gamma\vdash t \tpsynth T' & T \cong T'} \\ \\
    \infer{\Gamma\vdash \phi\ t\ \mhyph\ t'\{t''\} \Leftrightarrow T}
          {\Gamma\vdash t\tpsynth \{t'\simeq t''\} & \Gamma\vdash t' \Leftrightarrow T}  & \
  \end{array}
  \]
\caption{Rules for checking a term against a well-kinded type ($\Gamma \vdash t \tpcheck T$)
           and synthesizing a type for a term ($\Gamma \vdash t \tpsynth T$)}
\label{fig:tp}
\end{figure}


\begin{figure}
  \[
  \begin{array}{lllllll}
    |x| & = & x &\ &
    |\abs{\lambda}{x}{t'}{t}| & = & \absu{\lambda}{x}{|t|} \\
    |t\ t'| & = & |t|\ |t'| &\ &
    |t\cdot T| & = & |t| \\
    |\abs{\Lambda}{x}{t'}{t}| & = & |t| &\ &
    |t\ \mhyph t'| & = & |t| \\
    |[t , t']| & = & |t| &\ &
    |t.1| & = & |t| \\
    |t.2| & = & |t| &\ &
    |\beta\{t\}| & = & |t|\\
    |\delta\ \mhyph\ t| & = & |t|&\ &
    |\rho\ t\ \mhyph\ t'| & = & |t'| \\
    |\phi\ t\ \mhyph\ t'\ \{t''\}| & = & |t''| &\ &
    |\chi\ T\ \mhyph\ t'| & = & |t'|
  \end{array}
  \]
  \caption{Erasure for annotated terms}
  \label{fig:eraser}
\end{figure}  

\begin{figure}
  \[
  \begin{array}{ll}
    \infer{T \cong T'}{T \leadsto^*_\beta T_1 & T' \leadsto^*_\beta T_2 & T_1\cong^t T_2}  & 
    \infer{T \cong T'}{T \cong^t T'} \\ \\
    \infer{T\ t \cong^t T\ t'}{T \cong^t T' & |t| =_{\beta\eta} |t'|} &
    \infer{\{ t_1 \simeq t_2 \} \cong^t \{ t_1'\ \simeq t_2' \}}{|t_1| =_{\beta\eta} |t_1'| & |t_2| =_{\beta\eta} |t_2'|}
  \end{array}
  \]
  \caption{Non-congruence rules for conversion}
  \label{fig:conv}
\end{figure}  

\subsection{Overview of the constructs}
\label{sec:overview}

CDLE has as a subsystem the extrinsic Calculus of
Constructions (CC).  We have dependent types
$\abs{\Pi}{x}{T}{T'}$ and kinds $\abs{\Pi}{x}{T}{\kappa}$, as well as
term- and type-level quantification over (possibly higher-kinded)
types $\abs{\forall}{X}{\kappa}{T}$ and
$\abs{\Pi}{X}{\kappa}{\kappa'}$.  We use $\forall$ when the
corresponding argument will be erased, and $\Pi$ when it will be
retained.  Since we do not erase term or type arguments from
type-level applications, we thus write $\abs{\Pi}{X}{\kappa}{\kappa'}$
instead of $\abs{\forall}{X}{\kappa}{\kappa'}$.  We write $\lambda$ to
correspond to $\Pi$ and $\Lambda$ to correspond to $\forall$.  As noted
above, application to a type is denoted with center dot ($\cdot$).

To Curry-style CC, CDLE adds: implicit products, introduced orginially
by Miquel~\cite{miquel01}; a primitive equality type $\{ t \simeq
t'\}$; and dependent intersection types $\abs{\iota}{x}{T}{T'}$,
introduced by Kopylov~\cite{kopylov03}.  Implicit products are used
for erased arguments to functions, found also in systems like Agda
(cf.~\cite{mishraLinger08}).  Dependent intersections are a rather
exotic construct allowing us to assign type $\abs{\iota}{x}{T'}{T}$ to
erased term $t$ when we can assign $T'$ to $t$, and also assign
$[t/x]T$ to $t$.  For an annotated introduction form, we write
$[t,t'$], where $t$ checks against type $T'$, $t'$ checks against
$[t/x]T$, and $t$ and $t'$ have identical (i.e., $\alpha$-equivalent)
erasures.  Dependent intersections thus enable a controlled form of
self-reference in the type.  Previous work showed how to use this to
derive induction for Church-encoded natural numbers~\cite{stump18}.
We will see below further uses of this construct.

The typing rules include conversion checks in a few places; e.g., as
standardly, when switching from checking to synthesizing mode.  Two
rules near the top of Figure~\ref{fig:tp} state that one may (nondeterministically)
$\beta$-reduce the type one is synthesizing or checking, before proceeding.
This allows reduction to head-normal form,
to match the form of type required by other rules.
Finally, we include the construct $\chi\ T\ \mhyph\ t$ to change the
synthesized or checked type $T'$ to $T$, if $T \cong T'$.  This may
be necessary to get the type into a specific form for purposes of rewriting
with the $\rho$ construct.

Finally, we have modified
the rules for equality types $\{ t \simeq t' \}$ so that we require
nothing of $t$ and $t'$ except that the set $\textit{dom}(\Gamma)$ of variables
declared by $\Gamma$ includes their free variables $\textit{FV}(t\ t')$.  Further modifications
over the version of CDLE in~\cite{stump18} are:
\begin{itemize}
\item To prove $\{ t \simeq t\}$, one now writes $\beta\{t'\}$,
  with the critical idea that $|\beta\{t\}|$ erases to $|t|$.  We call this the \textbf{Kleene trick},
  because it goes back to Kleene's numeric realizability, which accepts any number $n$ as a realizer
  of a true equation.  Here, we accept any closed term $t$ as a realizer
  of $\{ t \simeq t\}$.  This means that in Cedille, any such term -- even otherwise untypable
  terms, non-normalizing terms, etc. -- have type $\{ t \simeq t\}$ for any term $t$.
\item The $\rho$ construct allows one to rewrite occurrences of $t_1$ to $t_2$ in the synthesized or
  checked type, where $t_1$ and $t_2$ are provably equal.  In the Cedille implementation, we rewrite
  all matching occurrences.  This may be compared to \verb|rewrite| in Agda, except that it may be
  applied anywhere, not just as part of pattern matching~\cite{agda}.
\item We adopt a strong form of Nuprl's \textbf{direct computation rules}~\cite{constable+86}:
  If we have a term $t'$ of type $T$ and a proof $t$ that $\{ t' \simeq t''\}$, then we may conclude that
  $t''$ has type $T$ by writing the annotated term $\phi\ t\ \mhyph\ t'\{t''\}$, which
  erases to $t''$.
\item Where the previous version of CDLE uses $\beta$-equivalence for (erased) terms, we here adopt $\beta\eta$-equivalence.  This
  allows us to observe in many cases that retyping functions are actually $\beta\eta$-equivalent to $\absu{\lambda}{x}{x}$.
  While $\beta\eta$-equivalence takes more work to incorporate into intrinsic 
  type theory~\cite{geuvers92},
  it raises no difficulties for our extrinsic one.
\item In this version, we add an explicit axiom $\delta$ saying that Church-encoded boolean \emph{true} is different from
  \emph{false}.  In the first version of CDLE, such an axiom was derivable from \emph{lifting}, a construct allowing
  simply typable terms to be lifted to the type level~\cite{stump17}.  We omit lifting in this new version of CDLE, because while
  sound, lifting as defined in that previous work is complicated and appears to be incomplete.  Developing a new
  form of lifting remains to future work.
\end{itemize}

The equality type remains \textbf{intensional}: we equate terms iff they are $\beta\eta$-equal.  

\subsection{Semantics and metatheory}

Figure~\ref{fig:semtp} gives a realizability semantics for types and
kinds, following the semantics given in the previous papers on
CDLE~\cite{stump18,stump17}.  Details of this semantics are presented
further in Section~\ref{sec:snd} below.  Using the semantics and the
definition in Figure~\ref{fig:semctxt} of $\interp{\Gamma}$, we can
prove the following theorem:
\begin{theorem}[Soundness]
\label{thm:snd}
Suppose $(\sigma,\rho)\in\interp{\Gamma}$.  Then we have:
\begin{enumerate}
\item If $\Gamma\vdash \kappa$, then $\interp{\kappa}_{\sigma,\rho}$ is defined.
\item If $\Gamma\vdash T \tpsynth \kappa$, then $\interp{T}_{\sigma,\rho}\in\interp{\kappa}_{\sigma,\rho}$.
\item If $\Gamma\vdash t \tpsynth T$ then $[\sigma |t|]_{\cbe}\in\interp{T}_{\sigma,\rho}\in \mathcal{R}$.
\item If $\Gamma\vdash t \tpcheck T$ and $\interp{T}_{\sigma,\rho}\in \mathcal{R}$, then
    $[\sigma |t|]_{\cbe}\in\interp{T}_{\sigma,\rho}\in \mathcal{R}$.
\item If $T \cong T'$ or $T \cong^t T'$ and $\interp{T}_{\sigma,\rho}$ and $\interp{T'}_{\sigma,\rho}$ are both defined, then they are equal.
\end{enumerate}
\end{theorem}

An easy corollary, by the semantics of $\forall$-types, is then:

\begin{theorem}[Logical consistency]
\label{thm:consis}
  There is no term $t$ such that $\vdash t : \abs{\forall}{X}{\star}{X}$.
\end{theorem}

It may worry some readers that we have:
\begin{observation}
  There are typable terms $t$ which fail to normalize.
\end{observation}

Defining \verb|Top| to be $\{\absu{\lambda}{x}{x} \simeq
\absu{\lambda}{x}{x}\}$, we may assign \verb|Top| to any closed term \verb|t|,
including non-normalizing ones. In our annotated syntax, we write
\texttt{\(\beta\)\{t\}}. Even without this, the presence of $\delta$ in
combination with $\phi$ allows us to type non-normalizing terms assuming an
erased argument $x$ of type $\{ \textit{tt} \simeq \textit{ff} \}$ for
Church-encoded booleans \textit{tt} and \textit{ff}. For example, $\delta\ \mhyph x$
has type \(\{\absu{\lambda}{x}{x} \simeq \absu{\lambda}{x}{x\ x}\}\), and with
$\phi$ we can use this to type $\Omega$ by changing the typed term
\(\texttt{id}\ \cdot\texttt{True}\ \texttt{id}\), where \verb|True| is
\(\abs{\forall}{X}{\star}{X \to X}\). But failure of normalization does not
impinge on Theorem~\ref{thm:consis}. Extensional Martin-L\"of type theory (MLTT)
is also non-normalizing, for a very similar reason, but this fact does not contradict
its logical soundness~\cite{dybjer16}. In CDLE, the guarantees one gets about
the behavior of terms are expressed almost entirely in their types. If the types
are weak, then not much is guaranteed; but stronger types can guarantee
properties like normalization, as demonstrated by the following theorem:

\begin{theorem}[Call-by-name normalization of functions]
  \label{thm:cedille-termination}
  Suppose \(\Gamma\vdash t : T\), $t$ is closed, and there exists a closed term
  $t'$ which erases to \(\lambda x.\ x\) and whose type is $T \to \Pi x : T_1.\
  T_2$ for some $T_1, T_2$. Then $|t|$ is call-by-name normalizing.
  \end{theorem}

Given the lack of normalization in general, several checks in the typing rules --
for things like $t =_{\beta\eta} t'$ -- are formally undecidable.  In
practice, we simply impose a bound on the number of steps of reduction,
and thus restore formal decidability (we are checking ``typable within
a given budget'').  In practice, the same is done for Coq and Agda,
where type checking is decidable but, in general, infeasible (since one
may write astronomically slow terminating functions).

Finally, in line with ideas recently advocated by Dreyer, we
do not concern ourselves with syntactic
type preservation~\cite{dreyer18}, noting instead that by construction,
semantic types $\interp{T}_{\sigma,\rho}$ are preserved by $\beta\eta$-reduction:

  \begin{theorem}[Semantic type preservation]
    If $t \leadsto_{\beta\eta} t'$ and $t\in\interp{T}_{\sigma,\rho}$, then $t'\in\interp{T}_{\sigma,\rho}$.
    \end{theorem}

  Confluence of $\beta\eta$-reduction for (erased)
  terms is nothing other than confluence of untyped lambda calculus.
  This is because, as easily verified by inspecting
  Figure~\ref{fig:eraser}, the erasure function maps annotated terms
  $t$ to terms $|t|$ of pure untyped lambda calculus.
\begin{comment}
  \begin{lemma}
    If $t$ is an annotated term of CDLE, then $|t|$ is a term of pure untyped lambda calculus.
    \end{lemma}
\end{comment}    

\begin{figure}
\[
\begin{array}{lll}
\interp{X}_{\sigma,\rho} & = & \rho(X) \\ 
\interp{\Pi x : T_1. T_2}_{\sigma,\rho} & = & 
    [\{ \lambda x.t\ |\ \forall E\in\interp{T_1}_{\sigma,\rho}.\\
\ &\ &\ \ \ \  [[\choice(E)/x]t]_{\cbe}\in\interp{T_2}_{\sigma[x\mapsto \choice(E)],\rho} \ \wedge\ t = |t|\}]_{\cbe}
 \\
\interp{\forall X:\kappa.T}_{\sigma,\rho} & = & 
  \elcap \{ \interp{T}_{\sigma,\rho[X\mapsto S]} |\ S\in\interp{\kappa}_{\sigma,\rho} \}  \\ 
\interp{\forall x:T.T'}_{\sigma,\rho} & = & 
  \elcap_\star \{ \interp{T'}_{\sigma[x\mapsto \choice(E)],\rho}\ |\ E\in\interp{T}_{\sigma,\rho} \} \\ 
\interp{\iota x:T.T'}_{\sigma,\rho} & = & \{ E\in\interp{T}_{\sigma,\rho} |\ E \in \interp{T'}_{\sigma[x\mapsto \choice(E)],\rho} \} \\ 
\interp{\lambda X:\kappa.T}_{\sigma,\rho} & = & (S\in\interp{\kappa}_{\sigma,\rho} \mapsto \interp{T}_{\sigma,\rho[X\mapsto S]}) 
\\ 
\interp{\lambda x:T.T'}_{\sigma,\rho} & = & 
    (E\in\interp{T}_{\sigma,\rho} \mapsto \interp{T'}_{\sigma[x\mapsto \choice(E)],\rho}) 
\\ 
\interp{T\ T'}_{\sigma,\rho} & = & \interp{T}_{\sigma,\rho}(\interp{T'}_{\sigma,\rho})
\\ 
\interp{T\ t}_{\sigma,\rho} & = & \interp{T}_{\sigma,\rho}([\sigma |t|]_{\cbe})
\\
\interp{t \simeq t'}_{\sigma,\rho} & = & [\{ t''\ |\ \sigma |t| =_{\beta\eta} \sigma |t'|\ \wedge\ t'' = |t''| \}]_{\cbe} \\
\ &\ &\ \ \ \textnormal{ if }\textit{FV}(t\ t')\subseteq\textit{dom}(\sigma) 
\\
\interp{\star}_{\sigma,\rho} & = & \mathcal{R} \\ 
\interp{\Pi x:T.\kappa}_{\sigma,\rho} & = & 
(E\in\interp{T}_{\sigma,\rho} \to \interp{\kappa}_{\sigma[x\mapsto \choice(E)],\rho}),\\
\ &\ &\ \ \ \textnormal{ if }\interp{T}_{\sigma,\rho}\in\mathcal{R} \\
\interp{\Pi x:\kappa.\kappa'}_{\sigma,\rho} & = & (S\in\interp{\kappa}_{\sigma,\rho} \to \interp{\kappa}_{\sigma,\rho[X\mapsto S]}) \\
\elcap_\star X & = & \left\{\begin{array}{l}
                                         \, \negthinspace\elcap X, \textnormal{ if } X\neq\emptyset\\
                                         \, \negthinspace[\mathcal{L}]_{\cbe},\textnormal{ otherwise}
                                       \end{array}\right. \\
\end{array}
\]
\caption{Semantics for types and kinds}
\label{fig:semtp}
\end{figure}

\begin{figure}
\[
\begin{array}{lll}
(\sigma\uplus[x\mapsto t],\rho)\in\interp{\Gamma,x:T} & \Leftrightarrow & (\sigma,\rho)\in\interp{\Gamma} \ \wedge\ 
 [t]_{\cbe}\in\interp{T}_{\sigma,\rho}\in\mathcal{R}\ \wedge\ t = |t| \\
(\sigma,\rho\uplus[X\mapsto S])\in\interp{\Gamma,X:\kappa} & \Leftrightarrow & (\sigma,\rho)\in\interp{\Gamma} \ \wedge\ 
S\in\interp{\kappa}_{\sigma,\rho} \\
(\emptyset,\emptyset)\in\interp{\cdot}
\end{array}
\]
\caption{Semantics of typing contexts $\Gamma$}
\label{fig:semctxt}
\end{figure}

\subsection{Some details about the semantics and the proof of Theorem~\ref{thm:snd}}
\label{sec:snd}

Following the development in~\cite{stump17}, we work with
set-theoretic partial functions for the semantics of higher-kinded
types.  Types are interpreted as $\beta\eta$-closed sets of closed
terms. Let $\mathcal{L}$ be the set of closed terms of pure lambda calculus
(differently from~\cite{stump17}, we include all terms at this point,
even non-normalizing ones).  We
write $=_{\cbe}$ for standard $\beta\eta$-equivalence of pure lambda calculus, restricted to
closed terms; and $[t]_{\cbe}$ for $\{ t'\ |\ t =_{\cbe} t'\}$.  This
is extended to sets $S$ of terms by writing $[S]_{\cbe}$ for
$\{[t]_{\cbe}\ |\ t\in S\}$.  In a few places we write
$\textit{nf}(t)$ for the (unique) $\beta\eta$-normal form of term $t$,
if it has one.  If (in our meta-language) we affirm a statement
involving application of a partial function, then it is to be
understood that that application is defined.

\begin{definition}[Reducibility candidates]
  $\mathcal{R} := \{ [S]_{\cbe}\ |\ S\subseteq \mathcal{L} \}$.
\end{definition}

Throughout the development we find it convenient to use a
\textbf{choice function} $\choice$.  Given any nonempty set $E$ of
terms, $\choice$ returns some element of $E$.  Note that if $a \in A
\in \mathcal{R}$, then $a$ is a nonempty set of terms of pure lambda
calculus; it can also happen that $A \in\mathcal{R}$ is empty.  The
proof of Theorem~\ref{thm:snd} (see appendix) is then a straightforward adaptation of~\cite{stump17}. 

\textbf{Acknowledgments.}  This work was partially supported by the US
NSF support under award 1524519, and US DoD support under award
FA9550-16-1-0082 (MURI program).



\begin{thebibliography}{10}

\bibitem{constable+86}
Robert~L. Constable, Stuart~F. Allen, Mark Bromley, Rance Cleaveland, J.~F.
  Cremer, R.~W. Harper, Douglas~J. Howe, Todd~B. Knoblock, N.~P. Mendler,
  Prakash Panangaden, James~T. Sasaki, and Scott~F. Smith.
\newblock {\em Implementing mathematics with the Nuprl proof development
  system}.
\newblock Prentice Hall, 1986.

\bibitem{dreyer18}
Derek Dreyer.
\newblock {The Type Soundness Theorem That You Really Want to Prove (and Now
  You Can)}.
\newblock Milner Award Lecture, delivered at Principles of Programming
  Languages (POPL), 2018.

\bibitem{dybjer16}
Peter Dybjer and Erik Palmgren.
\newblock {Intuitionistic Type Theory}.
\newblock In Edward~N. Zalta, editor, {\em The Stanford Encyclopedia of
  Philosophy}. Metaphysics Research Lab, Stanford University, winter 2016
  edition, 2016.

\bibitem{geuvers92}
Herman Geuvers.
\newblock {The Church-Rosser Property for beta-eta-reduction in Typed
  lambda-Calculi}.
\newblock In {\em Proceedings of the Seventh Annual Symposium on Logic in
  Computer Science {(LICS} '92), Santa Cruz, California, USA, June 22-25,
  1992}, pages 453--460. {IEEE} Computer Society, 1992.

\bibitem{Kashima2000}
  Ryo Kashima.
  \newblock {A Proof of the Standardization Theorem in \(\lambda\)-Calculus}.
  \newblock Available from the author's web page, 2000.

\bibitem{kopylov03}
Alexei Kopylov.
\newblock Dependent intersection: {A} new way of defining records in type
  theory.
\newblock In {\em 18th {IEEE} Symposium on Logic in Computer Science {(LICS)}},
  pages 86--95, 2003.

\bibitem{agda}
\mbox{The Agda development team}.
\newblock {\em Agda}, 2018.
\newblock Version 2.5.4.

\bibitem{miquel01}
Alexandre Miquel.
\newblock {The Implicit Calculus of Constructions Extending Pure Type Systems
  with an Intersection Type Binder and Subtyping}.
\newblock In Samson Abramsky, editor, {\em {Typed Lambda Calculi and
  Applications}}, volume 2044 of {\em Lecture Notes in Computer Science}, pages
  344--359. Springer, 2001.

\bibitem{mishraLinger08}
Nathan Mishra{-}Linger and Tim Sheard.
\newblock {Erasure and Polymorphism in Pure Type Systems}.
\newblock In Roberto~M. Amadio, editor, {\em Foundations of Software Science
  and Computational Structures, 11th International Conference, {FOSSACS} 2008,
  Held as Part of the Joint European Conferences on Theory and Practice of
  Software, {ETAPS} 2008, Budapest, Hungary, March 29 - April 6, 2008.
  Proceedings}, volume 4962 of {\em Lecture Notes in Computer Science}, pages
  350--364. Springer, 2008.

\bibitem{peytonjones07}
Simon Peyton~Jones, Dimitrios Vytiniotis, Stephanie Weirich, and Mark Shields.
\newblock {Practical Type Inference for Arbitrary-rank Types}.
\newblock {\em J. Funct. Program.}, 17(1):1--82, January 2007.

\bibitem{pierce+00}
Benjamin~C. Pierce and David~N. Turner.
\newblock Local type inference.
\newblock {\em {ACM} Trans. Program. Lang. Syst.}, 22(1):1--44, 2000.

\bibitem{stump17}
Aaron Stump.
\newblock {The Calculus of Dependent Lambda Eliminations}.
\newblock {\em J. Funct. Program.}, 27:e14, 2017.

\bibitem{stump18}
Aaron Stump.
\newblock {From Realizability to Induction via Dependent Intersection}, 2018.
\newblock in press.

\end{thebibliography}


%% Appendix
\appendix

\section{Proof of Theorem~\ref{thm:snd}}

First a few lemmas (easy proofs omitted):

\begin{lemma}
  $\interp{\kappa}_{\sigma,\rho}$ is nonempty if defined.
\end{lemma}

\begin{lemma}
\label{lem:choice}
If $E$ is nonempty, then $[\choice(E)]_{\cbe} = E$
\end{lemma}

\begin{lemma}
  The set $\mathcal{R}$ ordered by subset forms a complete lattice,
  with greatest element $[\mathcal{L}]_{\cbe}$ and greatest lower bound
  of a nonempty set of elements given by
  intersection.  Also, $\emptyset$ is the least element.
\end{lemma}

\begin{lemma}[Term substitution and interpretation]
\label{lem:termsubstinterp}
If $t' =_{\cbe} \sigma |t|$, then: 
\begin{itemize}
\item $\interp{T}_{\sigma[x\mapsto t'],\rho} = \interp{[t/x]T}_{\sigma,\rho}$
\item $\interp{\kappa}_{\sigma[x\mapsto t'],\rho} = \interp{[t/x]\kappa}_{\sigma,\rho}$
\end{itemize}
\end{lemma}

\begin{lemma}[Type substitution and interpretation] 
\label{lem:tpsubstinterp}
\begin{itemize}
\item $\interp{T}_{\sigma,\rho[X\mapsto\interp{T'}_{\sigma,\rho}]} = \interp{[T'/X]T}_{\sigma,\rho}$
\item $\interp{\kappa}_{\sigma,\rho[X\mapsto\interp{T'}_{\sigma,\rho}]} = \interp{[T'/X]\kappa}_{\sigma,\rho}$
\end{itemize}
\end{lemma}

\begin{lemma}
  \label{lem:interppres}
  If $T \leadsto^*_{\beta} T'$ and $\interp{T}_{\sigma,\rho}$ is defined, then $\interp{T'}_{\sigma,\rho}$ is also defined and equals $\interp{T}_{\sigma,\rho}$.
\end{lemma}
\begin{proof}
  This follows by induction on the reduction derivation, making use of the previous substitution lemmas.
  \end{proof}

\begin{proof}[Soundness (Theorem~\ref{thm:snd})]
  The following proof is adapted from~\cite{stump17}.  It proceeds by
  mutual induction on the assumed typing, kinding, or superkinding
  derivation, for each part of the lemma.  We prove the parts
  successively.  

\subsection{Proof of part (1)}

\startcase{.2cm}
\[
\infer{\Gamma \vdash \star }{\ }
\]
$\interp{\star}_{\sigma,\rho}$ is just $\mathcal{R}$, which is
defined.  

\startcase{.2cm}
\[
    \infer{\Gamma\vdash\abs{\Pi}{x}{T}{\kappa}}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash\kappa} 
\]
By the IH, $\interp{T}_{\sigma,\rho}\in\mathcal{R}$, and so
$\interp{\Pi x : T.\, \kappa}_{\sigma,\rho}$ is
$(E\in\interp{T}_{\sigma,\rho} \to \interp{\kappa}_{\sigma[x\mapsto  \choice(E)],\rho})$.
The latter quantity is defined if for all
$E\in\interp{T}_{\sigma,\rho}$, $\interp{\kappa}_{\sigma[x\mapsto \choice(E)],\rho})$ is, too.  Since
$\interp{T}_{\sigma,\rho}\in\mathcal{R}$, every element $E$ of
$\interp{T}_{\sigma,\rho}$ is nonempty, as noted above, 
so $\choice(E)$ is defined.  We may apply the IH to the second
premise, since
$(\sigma[x\mapsto\choice(E)],\rho)\in\interp{\Gamma,x:T}$, because $E\in\interp{T}_{\sigma,\rho}$ (by assumption)
and $[\choice(E)]_{\cbe} = E$.  This gives definedness of the semantics
of the $\Pi$-kind.

\startcase{.2cm}
\[
   \infer{\Gamma\vdash\abs{\Pi}{X}{\kappa'}{\kappa}}{\Gamma \vdash \kappa' & \Gamma,X:\kappa'\vdash\kappa}
\]
We must show $(S\in\interp{\kappa}_{\sigma,\rho} \to \interp{\kappa}_{\sigma,\rho[X\mapsto S]})$ is defined.
This is true if $\interp{\kappa}_{\sigma,\rho}$ is defined, which is the case by
the IH applied to the first premise; and if for all
$S\in\interp{\kappa}_{\sigma,\rho}$,
$\interp{\kappa}_{\sigma,\rho[X\mapsto S]}$ is defined.  The latter is
true by the IH applied to the second premise.  

\subsection{Proof of part (2)}

\startcase{.2cm}
\[
\infer{\Gamma \vdash X \tpsynth \kappa}{(X : \kappa) \in \Gamma} 
\]
From the definition of $\interp{\Gamma}$, we obtain
$\rho(x)\in\interp{\kappa}_{\sigma,\rho}$.

\startcase{.2cm}
\[
   \infer{\Gamma\vdash\abs{\Pi}{x}{T}{T'} \tpsynth \star}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash T' \tpsynth \star} 
\]
We must show $\interp{\Pi x:T.T'}_{\sigma,\rho}\in\mathcal{R}$. The
semantics defines $\interp{\Pi x:T.T'}_{\sigma,\rho}$ to be
$[A]_{\cbe}$ for a certain $A$, where if $A$ is defined, then
$A\subseteq\mathcal{L}$.  So it suffices to shown definedness. By the IH
for the first premise, $\interp{T}_{\sigma,\rho}\in\mathcal{R}$.  This
means that if $E\in\interp{T}_{\sigma,\rho}$, $\choice(E)$ is defined.
We can then apply the IH to the second premise, since
$\sigma[x\mapsto\choice(E)]\in\interp{\Gamma,x:T}$, to obtain
definedness of $\interp{T'}_{\sigma[x\mapsto\choice(E),\rho}$.


\startcase{.2cm}
\[
   \infer{\Gamma\vdash\abs{\forall}{x}{T}{T'} \tpsynth \star}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash T' \tpsynth \star} 
\]
By the IH for the second premise, $\interp{T_2}_{\sigma[x\mapsto  \choice(E)],\rho}\in\mathcal{R}$, for every
$E\in\interp{T_1}_{\sigma,\rho}$ where
$\interp{T_1}_{\sigma,\rho}\in\mathcal{R}$.  By the IH for the first
premise, we indeed have $\interp{T_1}_{\sigma,\rho}\in\mathcal{R}$.
So if $\interp{T_1}_{\sigma,\rho}$ is non-empty, then the intersection of all the sets
$\interp{T_2}_{\sigma[x\mapsto \choice(E)],\rho}$ where $E\in\interp{T_1}_{\sigma,\rho}$ is a
reducibility candidate, since each of those sets is.  By the semantics
of $\forall$-types quantifying over terms, this is sufficient.  If $\interp{T_1}_{\sigma,\rho}$ is
empty, then the interpretation of the $\forall$-type is $[\mathcal{L}]_{\cbe}$ by the definition
of $\elcap_\star$, and this is in $\mathcal{R}$.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \abs{\forall}{X}{\kappa}{T} \tpsynth \star}{\Gamma \vdash \kappa & \Gamma,X:\kappa\vdash T \tpsynth \star} 
\]
Similarly to the previous case: by the IH for the second premise,
$\interp{T_2}_{\sigma,\rho[X\mapsto S}\in\mathcal{R}$, for every
$S\in\interp{\kappa}_{\sigma,\rho}$.  By the IH part for the first
premise, $\interp{\kappa}_{\sigma,\rho}$ is defined.  So the
intersection of all the sets $\interp{T_2}_{\sigma,\rho[X\mapsto S]}$
where $S\in\interp{\kappa}_{\sigma,\rho}$ is a reducibility candidate,
since each of those sets is.  The intersection is nonempty, since $\interp{\kappa}_{\sigma,\rho}$ is (as stated in a lemma above).
By the semantics of $\forall$-types
quantifying over types, this is sufficient. 

\startcase{.2cm}
\[
    \infer{\Gamma\vdash\abs{\iota}{x}{T}{T'} \tpsynth \star}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash T' \tpsynth \star} 
\]
The set $\interp{\iota x:T.T'}_{\sigma,\rho}$ is explicitly defined to
be a subset of $\interp{T}_{\sigma,\rho}$, which is in $\mathcal{R}$,
by the IH applied to the first premise.  Since for any
$A\subseteq\mathcal{L}$, $[A]_{\cbe}$ is in $\mathcal{R}$, to show that
$\interp{\iota x:T.T'}_{\sigma,\rho}$ is also in $\mathcal{R}$ it suffices
to show definedness of $\interp{T'}_{\sigma[x\mapsto \choice(E)],\rho}\}$
(which is used in the predicate picking out the
particular subset of $\interp{T}_{\sigma,\rho}$), for
$E\in\interp{T}_{\sigma,\rho}$.  For such $E$, $\choice(E)$ is defined
(since $\interp{T}_{\sigma,\rho}\in\mathcal{R}$ and hence $E\in\interp{T}_{\sigma,\rho}$ is nonempty)
and in $E$,
so $\sigma[x\mapsto\choice(E)]\in\interp{\Gamma,x:T}$.  So
by the IH for the second premise,
$\interp{T'}_{\sigma[x\mapsto\choice(E),\rho]}$ is defined.

\startcase{.2cm}
\[
 \infer{\Gamma\vdash\abs{\lambda}{x}{T}{T'} \tpsynth \abs{\Pi}{x}{T}{\kappa}}{\Gamma \vdash T \tpsynth \star & \Gamma,x:T\vdash T'\tpsynth\kappa}
\]
By the semantics, $\interp{\lambda x:T.T'}_{\sigma,\rho}$ is
$(E\in\interp{T}_{\sigma,\rho} \mapsto \interp{T'}_{\sigma[x\mapsto
  \choice(E)],\rho})$.  We must show that this (meta-level) function
is in $\interp{\Pi x:T.\kappa}_{\sigma,\rho}$.  By the semantics of
kinds, the latter quantity, if defined, is
$(E\in\interp{T}_{\sigma,\rho} \to_{\cbe}
\interp{\kappa}_{\sigma[x\mapsto \choice(E)],\rho})$.
By the IH for the first premise, $\interp{T}_{\sigma,\rho}\in\mathcal{R}$.
So we must just show that for any $E\in\interp{T}_{\sigma,\rho}$,
$\interp{T'}_{\sigma[x\mapsto
  \choice(E)],\rho}\in\interp{\kappa}_{\sigma[x\mapsto
  \choice(E)],\rho}$.  But this follows by the IH for the second
premise.

\startcase{.2cm}
\[
\infer{\Gamma\vdash\abs{\lambda}{X}{\kappa}{T'} \tpsynth \abs{\Pi}{X}{\kappa}{\kappa'}}
      {\Gamma \vdash \kappa & \Gamma,X:\kappa\vdash T'\tpsynth\kappa'} 
\]
This case is an easier version of the previous one.  It suffices to
assume an arbitrary $S\in\interp{\kappa}_{\sigma,\rho}$ and show
$\interp{T'}_{\sigma,\rho[X\mapsto S]}\in\interp{\kappa'}_{\sigma,\rho[X\mapsto S]}$.  But this follows
by the IH applied to the second premise.  And we have definedness of
$\interp{\kappa}_{\sigma,\rho}$ by the IH for the first premise.

\startcase{.2cm}
\[
   \infer{\Gamma\vdash T\ t \tpsynth [t/x]\kappa}{\Gamma\vdash T \tpsynth \abs{\Pi}{x}{T'}{\kappa} & \Gamma\vdash t \tpcheck T'} 
\]
By the IH for the first premise,
$\interp{T}_{\sigma,\rho}\in\interp{\Pi x:T'.\kappa}_{\sigma,\rho}$.
By the semantics of $\Pi$-kinds, this means that
$\interp{T}_{\sigma,\rho}$ is a function which given any
$E\in\interp{T'}_{\sigma,\rho}$, will produce a result in
$\interp{\kappa}_{\sigma[x\mapsto \choice(E)],\rho}$.  By the
semantics of type applications, $\interp{T\ t}_{\sigma,\rho}$ is equal
to $\interp{T}_{\sigma,\rho}([\sigma |t|]_{\cbe})$.  This is defined,
since $[\sigma |t|]_{\cbe}\in\interp{T'}_{\sigma,\rho}$, by the IH for
the second premise; note that $\interp{T'}_{\sigma,\rho}$ is defined
since otherwise $\interp{\Pi x:T'.\kappa}_{\sigma,\rho}$ would not be defined.
The result of applying the function is thus indeed
in $\interp{[t/x]\kappa}_{\sigma,\rho}$, since by
Lemma~\ref{lem:termsubstinterp}, this equals
$\interp{\kappa}_{\sigma[x\mapsto \choice([\sigma |t|]_{\cbe})],\rho}$
(the codomain of the function being applied).

\startcase{.2cm}
\[
\infer{\Gamma\vdash T\cdot T' \tpsynth [T'/X]\kappa}
      {\Gamma\vdash T \tpsynth \abs{\Pi}{X}{\kappa'}{\kappa} & \Gamma\vdash T' \tpsynth \kappa' & \kappa \cong \kappa'} 
\]
By the IH applied to the first premise,
$\interp{T}_{\sigma,\rho}\in\interp{\abs{\Pi}{X}{\kappa'}{\kappa}}_{\sigma,\rho}$.
By the semantics of $\Pi$-kinds, this means that for any
$S\in\interp{\kappa'}_{\sigma,\rho}$, $\interp{T}_{\sigma,\rho}\ S$ is in
$\interp{\kappa}_{\sigma,\rho[X\mapsto S]}$.  By the IH for the second premise, we have 
$\interp{T'}\interp{\kappa'}_{\sigma,\rho}$, and by the IH for the third premise,
we have $\interp{\kappa}_{\sigma,\rho} = \interp{\kappa'}_{\sigma,\rho}$.  So
we get $\interp{T}_{\sigma,\rho}(\interp{T'}_{\sigma,\rho})\in \interp{\kappa}_{\sigma,\rho[X\mapsto \interp{T'}_{\sigma,\rho}]}$,
which suffices by Lemma~\ref{lem:tpsubstinterp}.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \{ t \simeq t' \} : \star}{\textit{FV}(t\ t')\subseteq\textit{dom}(\Gamma)}
\]
Either $\sigma |t| =_{\cbe} \sigma |t'|$ or not.  Either way, the interpretation is defined and in $\mathcal{R}$, since
$\textit{FV}(t\ t')\subseteq\textit{dom}(\sigma)$ (as an easy consequence of $(\sigma,\rho)\in\interp{\Gamma}$).

\subsection{Proof of parts (3) and (4)}

\startcase{.2cm}
\[
    \infer{\Gamma\vdash x\tpsynth T}{(x : t)\in\Gamma} 
\]
This follows from the definition of $\interp{\Gamma}$.

\startcase{.2cm}
\[
 \infer{\Gamma\vdash t\tpcheck T'}{\Gamma\vdash t \tpcheck T & T' \leadsto^*_\beta T} 
\]
We are assuming $\interp{T'}_{\sigma,\rho}$ is defined, since this is a checking judgment. The desired result then
follows from Lemma~\ref{lem:interppres}.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash t\tpsynth T'}{\Gamma\vdash t \tpsynth T & T \leadsto^*_\beta T'} 
\]
This also follows from Lemma~\ref{lem:interppres} and the induction hypothesis for the first premise,
which implies $\interp{T}_{\sigma,\rho}\in\mathcal{R}$ (and hence defined).

\startcase{.2cm}
\[
\infer{\Gamma\vdash t\tpcheck T}{\Gamma\vdash t\tpsynth T' & T' \cong T} 
\]
By the IH applied to the first premise, we have 
$[\sigma t]_{\cbe}\in\interp{T'}_{\sigma,\rho}\in\mathcal{R}$. By assumption, $\interp{T}_{\sigma,\rho}\in\mathcal{R}$,
and so by the IH applied to the second premise, we have $[\sigma t]_{\cbe}\in\interp{T'}_{\sigma,\rho} = \interp{T}_{\sigma,\rho}$.


\startcase{.2cm}
\[
    \infer{\Gamma\vdash \absu{\lambda}{x}{t} \tpcheck \abs{\Pi}{x}{T}{T'}}{\Gamma,x:T\vdash t\tpcheck T'} 
\]
To show $[\sigma \lambda x.t]_{\cbe}\in\interp{\Pi  x:T.T'}_{\sigma,\rho}$ (noting that the latter is defined
and in $\mathcal{R}$ by assumption), it suffices to assume an arbitrary
$E\in\interp{T}_{\sigma,\rho}$, and show
$[[\choice(E)/x]\sigma t]_{\cbe}\in\interp{T'}_{\sigma[x\mapsto\choice(E)],\rho}$.  By the IH,
we have
$[\sigma[x\mapsto\choice(E)]t]_{\cbe}\in\interp{T'}_{\sigma[x\mapsto\choice(E)],\rho}$.
But $[\sigma[x\mapsto\choice(E)]t]_{\cbe} = [[\choice(E)/x]\sigma t]_{\cbe}$,
so this is sufficient.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash t\ t' \tpsynth [t'/x]T}{\Gamma\vdash t \tpsynth \abs{\Pi}{x}{T'}{T} & \Gamma\vdash t' \tpcheck T'} 
\]
By the IH applied to the first premise, $[\sigma
t]_{\cbe}\in\interp{\Pi x:T'.T}_{\sigma,\rho}\in\mathcal{R}$.  This
means that there exists a $\lambda$-abstraction $\lambda x.\hat{t}$
such that $\lambda x.\hat{t} =_{\cbe} \sigma t$, by the semantics of $\Pi$-types.
Furthermore, for any $E\in\interp{T'}_{\sigma,\rho}$,
$[[\choice(E)/x]\hat{t}]_{\cbe}\in\interp{T}_{\sigma[x\mapsto\choice(E)],\rho}$.
By the IH applied to the second premise, $[\sigma t']_{\cbe}\in\interp{T'}_{\sigma,\rho}$,
so we can instantiate the quantifier in the previous formula to obtain
\[
 [[\choice([\sigma t']_{\cbe})/x]\hat{t}]_{\cbe}\in\interp{T}_{\sigma[x\mapsto\choice([\sigma t']_{\cbe})],\rho}
\]
By Lemma~\ref{lem:termsubstinterp}, this is equivalent to
\[
 [[\choice([\sigma t']_{\cbe})/x]\hat{t}]_{\cbe}\in\interp{[t'/x]T_2}_{\sigma,\rho}
\]
Since $\sigma (t\ t') =_{\cbe} (\lambda x.\hat{t})\ \sigma t' =_{\cbe} [[\choice([\sigma t']_{\cbe})/x]\hat{t}$,
this is sufficient.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \absu{\Lambda}{X}{t} \tpcheck \abs{\forall}{X}{\kappa}{T}}{\Gamma,X:\kappa\vdash t \tpcheck T} 
\]
By the IH, $[\sigma |t|]_{\cbe}\in\interp{T}_{\sigma,\rho[X\mapsto S]}$, for all $S\in\interp{\kappa}_{\sigma,\rho}$.
This is sufficient to prove $[\sigma |\absu{\Lambda}{X}{t}|]_{\cbe}\in\interp{\forall X:\kappa.T}_{\sigma,\rho}$, by the semantics
of $\forall$-types and definition of erasure.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash t \cdot T' \tpsynth [T'/X]T}
          {\Gamma\vdash t \tpsynth \abs{\forall}{X}{\kappa}{T} & \Gamma\vdash T' \tpcheck\kappa} 
\]
By the semantics of $\forall$-types and the IH applied to the first
premise, we have $[\sigma |t|]_{\cbe}\in\interp{T}_{\sigma,\rho[X\mapsto
  S]}$, for all $S\in\interp{\kappa}_{\sigma,\rho}$.  Since
$\interp{T'}_{\sigma,\rho}\in\interp{\kappa}_{\sigma,\rho}$ by the IH
applied to the second premise, we can derive $[\sigma t]_{\cbe}\in\interp{T}_{\sigma,\rho[X\mapsto \interp{T'}_{\sigma,\rho}]}$.
By Lemma~\ref{lem:tpsubstinterp},
this is equivalent to the required $[\sigma |t|]_{\cbe}\in\interp{[T'/X]T}_{\sigma,\rho}$,
using also the definition of erasure.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \absu{\Lambda}{x}{t} \tpcheck \abs{\forall}{x}{T'}{T}}{\Gamma,x:T'\vdash t \tpcheck T & x\not\in\textit{FV}(|t|)} 
\]

By the IH applied to the first premise, we have
$[\sigma[x\mapsto\choice(E)]
t]_{\cbe}\in\interp{T'}_{\sigma[x\mapsto\choice(E)],\rho}$, for any
$E\in\interp{T}_{\sigma,\rho}$.  This is because
$\interp{T}_{\sigma,\rho}\in\mathcal{R}$, since $\interp{\abs{\forall}{x}{T'}{T}}_{\sigma,\rho}$ is in $\mathcal{R}$ and
hence defined, by assumption.  Since $x\not\in\textit{FV}(t)$, we know
$[[\sigma[x\mapsto\choice(E)]t]_{\cbe} = [\sigma t]_{\cbe}$.  By the
semantics of $\forall$-types and definition of erasure, this suffices to show the desired
conclusion.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash t\ \mhyph t' \tpsynth [t'/x]T}{\Gamma\vdash t \tpsynth \abs{\forall}{x}{T'}{T} & \Gamma\vdash t' \tpcheck T'}
\]
The result follows easily by the IH applied to the premises, the
semantics of $\forall$-types, definition of erasure, and Lemma~\ref{lem:termsubstinterp}.


\startcase{.2cm}
\[
    \infer{\Gamma\vdash [ t , t' ] \tpcheck \abs{\iota}{x}{T}{T'}}
          {\Gamma\vdash t \tpcheck T & \Gamma\vdash t' \tpcheck [t/x]T' & |t| =_{\beta\eta} |t'|} 
\]
By the IH, we have $[\sigma |t|]_{\cbe}\in\interp{T}_{\sigma,\rho}$ and
$[\sigma |t|]_{\cbe}\in\interp{[t/x]T'}_{\sigma,\rho}$.  By
Lemma~\ref{lem:termsubstinterp}, the latter is equivalent to
$[\sigma t]_{\cbe}\in\interp{T'}_{\sigma[x\mapsto\choice([\sigma t]_{\cbe}),\rho}$.  These two facts about $[\sigma t]_{\cbe}$ are
sufficient, by the semantics of $\iota$-types, for the desired
conclusion, using also the fact (from the third premise) that $\sigma|t| =_{\cbe} \sigma|t'|$.

\startcase{.2cm}
\[
   \infer{\Gamma\vdash t.1 \tpsynth T}{\Gamma\vdash t \tpsynth \abs{\iota}{x}{T}{T'}} 
\]
The desired conclusion follows easily from the IH and the semantics of $\iota$-types.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash t.2 \tpsynth [t.1/x]T'}{\Gamma\vdash t \tpsynth \abs{\iota}{x}{T}{T'}} 
\]
Similar to the previous case, using Lemma~\ref{lem:termsubstinterp}.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \beta\{t'\} \tpcheck \{ t \simeq t \}}{\Gamma\vdash \textit{FV}(t)\subseteq \textit{dom}(\Gamma)}  
\]
$[\sigma|t'|]_{\cbe}\in\interp{\{ t \simeq t \}}_{\sigma,\rho}$ follows directly from the semantics of equality types.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \delta\ \mhyph\ t \tpcheck T}{\Gamma\vdash t\tpsynth \{ \absu{\lambda}{x}{\absu{\lambda}{y}{x}} \simeq \absu{\lambda}{x}{\absu{\lambda}{y}{y}}\}}  
\]
By the semantics of equality types, $[\sigma|t'|]_{\cbe}$ cannot be in the interpretation of the equation in the premise,
since the two terms in question are closed and not $\beta\eta$-equal.  By the IH applied to the first premise, however,
$[\sigma|t'|]_{\cbe}$ is in the interpretation of that equation.  This is a contradiction.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \rho\ t'\ \mhyph\ t \Leftrightarrow [t_2/x]T}
          {\Gamma\vdash t' \tpsynth t_1 \simeq t_2 & \Gamma \vdash t \Leftrightarrow [t_1/x]T} 
\]
By the IH applied to the first premise, $\sigma|t_1| =_{\beta\eta} \sigma|t_2|$.  The result then follows by the IH applied to the second premise,
and Lemma~\ref{lem:termsubstinterp}.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \chi\ T\ \mhyph\ t \tpcheck T'}
          {\Gamma\vdash T\tpcheck \star & \Gamma\vdash t \tpcheck T & T \cong T'} 
\]
Using the IH for the first premise and the assumption that $\interp{T'}_{\sigma,\rho}$ is in $\mathcal{R}$ and hence defined,
we can apply the IH to the third premise to get $\interp{T}_{\sigma,\rho} = \interp{T'}_{\sigma,\rho}$.  Using this and the IH for second premise,
we get the desired conclusion, using also the definition of erasure.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \chi\ T\ \mhyph\ t \tpsynth T}
          {\Gamma\vdash T\tpcheck \star & \Gamma\vdash t \tpsynth T' & T \cong T'} 
\]
By the IH applied to the second premise, we have $[\sigma|t|]_{\cbe}\in\interp{T'}_{\sigma,\rho}\in\mathcal{R}$.
Using definedness of $\interp{T'}_{\sigma,\rho}$ and the IH applied to the first premise, we can apply the
IH to the third premise to get $\interp{T}_{\sigma,\rho} = \interp{T'}_{\sigma,\rho}$, from which the desired
conclusion follows by definition of erasure.

\startcase{.2cm}
\[
    \infer{\Gamma\vdash \phi\ t\ \mhyph\ t'\{t''\} \Leftrightarrow T}
          {\Gamma\vdash t\tpsynth \{t'\simeq t''\} & \Gamma\vdash t' \Leftrightarrow T}  
\]
By the IH for the first premise, $\sigma|t'| =_{\cbe} \sigma|t''|$.  By the IH for the second
premise, $[\sigma|t'|]_{\cbe}\in\interp{T}_{\sigma,\rho}$.  This suffices for the desired conclusion,
using also the definition of erasure ($|\phi\ t\ \mhyph\ t'\{t''\}| = |t''|$).

\subsection*{Proof of part (5) }



\startcase{.2cm}
\[
    \infer{T \cong T'}{T \leadsto^*_\beta T_1 & T' \leadsto^*_\beta T_2 & T_1\cong^t T_2}  
\]
By Lemma~\ref{lem:interppres}, we have
\[
\begin{array}{lll}
  \interp{T}_{\sigma,\rho} & = & \interp{T_1}_{\sigma,\rho}\\
  \interp{T'}_{\sigma,\rho} & = & \interp{T_2}_{\sigma,\rho}
\end{array}
\]
By the IH for the third premise, we have $\interp{T_1}_{\sigma,\rho} = \interp{T_2}_{\sigma,\rho}$,
which suffices.

\startcase{.2cm}
\[
    \infer{T \cong T'}{T \cong^t T'} 
\]
By the IH.

\startcase{.2cm}
\[
    \infer{T\ t \cong^t T'\ t'}{T \cong^t T' & |t| =_{\beta\eta} |t'|}
\]
By the semantics, $\interp{T\ t}_{\sigma,\rho} =
\interp{T}_{\sigma,\rho}([\sigma|t|]_{\cbe})$.  By the second premise
and the IH for the first premise, this equals
$\interp{T'}_{\sigma,\rho}([\sigma|t'|]_{\cbe})$, as required.

\startcase{.2cm}
\[
    \infer{\{ t_1 \simeq t_2 \} \cong^t \{ t_1'\ \simeq t_2' \}}{|t_1| =_{\beta\eta} |t_1'| & |t_2| =_{\beta\eta} |t_2'|}
\]
This follows easily from the premises and the semantics of equality types.

\end{proof}

\section{Proof of Theorem~\ref{thm:cedille-termination}}
\begin{proof}
Theorem \ref{thm:snd} implies that since
$t'\ t$ is closed and of type $\Pi x:T_1.\ T_2$, we have
$[|t'\ t|]_{c\beta\eta}\in \interp{\Pi x:T_1.\ T_2}_{\cdot,\rho}$,
where $[|t'\ t|]_{c\beta\eta}$ is the set of closed terms which are
$\beta\eta$-equivalent to $|t'\ t|$; and
$(\cdot,\rho)\in\interp{\Gamma}$ gives interpretations $\cdot$ for
term- and $\rho$ for type-variables in $\Gamma$.  By the semantics of
types defined in Figure \ref{fig:semtp}, the
interpretation of a $\Pi$-type consists of sets of the form
$[\lambda x.\,t']_{c\beta\eta}$.  So we have that $|t'\ t|$ is $\beta\eta$-equivalent to
$\lambda x.\, t'$ for some $x, t'$.  
Since $|t'\ t|$ is $\beta$-equivalent to $t$, we know $t =_{\beta\eta} \lambda x.\, t'$.
It is then an easy consequence of the
standardization theorem for untyped lambda calculus that $|t|$ is
call-by-name normalizing (cf.~\cite{Kashima2000}).

\end{proof}


\end{document}
