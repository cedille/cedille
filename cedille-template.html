<!DOCTYPE html>
<html><head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">

  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <style id="compiled-css" type="text/css">

  /*TODO: understand absolute position & figure out a way to eliminate the slider bar*/

    .wrapper, .h-splitter, .v-splitter {
      position: absolute;
    }

    .window { padding: 5px; }

    #container {
      margin: 0 auto;
      position: relative;
      min-height: 100vh;
      display: flex;
      overflow: auto;
    }

    .left-wrapper{  }
    .right-wrapper{  }
    .top-wrapper{  }
    .bottom-wrapper{  }

    #code-wrapper {
      top: 0;
      height: 100%;
      left: 0;
      width: 39%;
      background-color: #FFFFF3;
      overflow: auto;
    }
    #misc-wrapper {
      top: 0;
      height: 100%;
      right: 0;
      width: 61%;
    }
    #h-splitter {
      left: 39%;
      width: 3px;
      background-color: #E9E9E9;
      cursor: move;
      z-index: 100;
      height: 100%;
    }
    #action-wrapper{
      background-color: #E9FFFF;
      top: 0;
      height: 35%;
      width:100%;
      overflow-y: auto;
    }
    #json-wrapper{
      background-color: #E9FFE9;
      height: 65%;
      bottom: 0;
      width: 100%;
      overflow-y: auto;
      /*padding: 10px;*/
    }
    #v-splitter{
      background-color: #E9E9E9;
      top: 35%;
      height: 3px;
      width:100%;
      cursor: move;
      z-index: 100;
    }
    #json-table{
      width: 100%;
      table-layout: fixed;
      overflow-x: auto;
    }
    td{
      border: 1px solid #EFEFEF;
      border-collapse: collapse;
      padding: 5px;
      overflow: hidden;
    }


  </style>

<!-- 1. Wrapper; 2. V/H splitter; 3. Window-->

</head>

<body style="cursor: auto;">
<div id="container">
    <div id="code-wrapper" class="wrapper">
      <div id="code" class="window"></div>
    </div>
    <div id="h-splitter" class="ui-draggable h-splitter"></div>
    <div id="misc-wrapper" class="wrapper">
      <div id="action-wrapper" class="wrapper">
        <div id="action" class="window">Welcome!</div>
      </div>
      <div id="v-splitter" class="ui-draggable v-splitter"></div>
      <div id="json-wrapper" class="wrapper">
          <table id="json-table" class="window"></table>
      </div>
    </div>
</div>
</body>

<script type="text/javascript">

//TODO: 
//- Show information as a small tag near the node?
//- Generate dependencies?
//- Add code highlighting corresponded to cedille-mode-faces
//- Code generation: use links for reusable refsheets? -> "render" folder with css & js scripts
//- Put root path in JSON Object for convenient reference?
//- Selection by spans
//- Dependencies' hyperlink
//- Escape special characters in code

//NOTE:
//JSON in el: highlighting faces from given spans, in cedille-mode-highlight & cedille-mode-faces
//JSON in agda: spans.agda, json.agda
//transferring data: main.agda, elab-util.agda, IAL??? 
//toplevel state -> gets dependent files(?)
//handler: main.agda, from command line or from el prompts
//dependency?

$(function(){
//Variables
  //JSON parsing
  var data = JSON.parse(document.getElementById('spans').innerHTML.replace(/\n/g, "\\n")),
      code = data.source,
      spans = data.spans,
  //<span> wrapping
      charStart = [], charEnd = [],
  //Code highlighting
      styleList = [["Star", "star", "#03FA57"],
                   ["Error", "error", "FF3333"], //cedille-error-face
                   ["Epsilon", "epsilon", "EE22D8"], //ced-purple-face
                   ["Hole", "hole", "33D6D0", "CC8888"], //cedille-hole-face
                   ["Comment", "comment", "E9E9E9"], //cedille-comment-face
                    ], // name, style name, font color
      termNames = styleList.map(function(i){return i[0]}),
      styleNames = styleList.map(function(i){return i[1]});

//Interface Resizing
    var vRange = function(container, elementA, elementB, splitter){
          var A = parseInt($(elementA).width(), 10),
              B = parseInt($(elementB).width(), 10),
              Z = parseInt($(splitter).width(), 10);
              //minw = parseInt((A + B + Z) * 10 / 100, 10);
          var result =
            [$(container).offset().left, //+ minw,
             $(container).offset().top,
             $(container).offset().left + $(container).width() - 5,
             $(container).offset().top + $(container).height()
            ];
          return result;
        },
        vSplitter = function(container, elementA, elementB){
            return function(event, ui){
              var // A = parseInt($(elementA).width(), 10),
                  // B = parseInt($(elementB).width(), 10),
                  w = $(container).width();
                  aw = parseInt(ui.position.left) / w * 100,
                  bw = 100 - aw;
              if(ui.position.left < $(container).left || aw >= 100) return;
              $(elementA).width(aw + '%');
              $(elementB).width(bw + '%');
              };
        },
        hRange = function(container, elementA, elementB, splitter){
          var A = parseInt($(elementA).height(), 10),
              B = parseInt($(elementB).height(), 10),
              Z = parseInt($(splitter).height(), 10);
              //minh = parseInt((A + B + Z) * 10 / 100, 10),
          var result =
            [$(container).offset().left,
             $(container).offset().top, //+ minh,
             $(container).offset().left + $(container).width(),
             $(container).offset().top + $(container).height()
            ];
          return result;
        },
        hSplitter = function(container, elementA, elementB){
            return function(event, ui){
              var h = $(container).height();
                  ah = parseInt(ui.position.top) / h * 100,
                  bh = 100 - ah;
              if(ui.position.top < $(container).top || ah >= 100) return;
              $(elementA).css({height : ah + '%'});
              $(elementB).css({height : bh + '%'});
              };
        };

    function makeDraggable(s, axis, c, e1, e2){
      var range = axis == 'x' ? vRange : hRange,
          splitter = axis == 'x' ? vSplitter : hSplitter;
      $(s).draggable({axis : axis, containment : range(c, e1, e2, s), drag : splitter(c, e1, e2)});
    }

    // $('#h-splitter').draggable({
    //   axis : 'x',
    //   containment : vRange('#container', '#code-wrapper', '#misc-wrapper', '#h-splitter'),
    //   drag : vSplitter('#code-wrapper','#misc-wrapper','#container')
    // });
    // $('#v-splitter').draggable({
    //   axis : 'y',
    //   containment : hRange('#misc-wrapper', '#action-wrapper', '#json-wrapper', '#v-splitter'),
    //   drag: hSplitter('#action-wrapper', '#json-wrapper', '#misc-wrapper')
    // });

//Action logging
  var actionLog = function(string) {
        $('#action').append("<div style:\"width:100%\">" + string + "</div>");
      },
      clearLog = function() {
        $('#action').text("")
      },
      logElementInfo = function(elm){
        var extra = elm[3];
        actionLog("<b>Term:</b> " + code.substring(elm[1]-1, elm[2]-1) 
                                  + " <i>[" + elm[0] + "]</i> <b>@ " 
                                  + elm[1] + "," + elm[2] + "</b>");
        $.each(extra, function (index, element) {
          actionLog("<b>" + index + ":</b> " + element);
        });
      };

  //<span> wrapping
  var recordStartPos = function(i){ charStart.push(i); },
      recordEndPos = function(i){ charEnd.push(i); };

  function wrapCode(c){
    var wrappedCode = "";
    for(var i = 0; i < c.length; i += 1){
      wrappedCode += "<span id=\"char-" + (i + 1) + "\" class=\"char\">"
                    +  c[i] + "</span>";
    }
    return wrappedCode;
  }

//Code highlighting
  function sortRangeFromStart(a, b){
    var spA = a[1], rgA = a[2] - a[1],
        spB = b[1], rgB = b[2] - b[1];
    if (spA == spB) return (rgB - rgA);
    else return (spA - spB); // larger span at the beginning of the list
  };

  //TODO: Add background configuration
  function addHighlightStyles() {
    var highlightSpans = JSON.parse(JSON.stringify( 
                                  spans.sort(sortRangeFromStart)
                                       .filter(function(i){return termNames.includes(i[0])})
                               )); // deep copy
    //Add classes for spans
    for(var i = 0; i < highlightSpans.length; i += 1){
      var name = highlightSpans[i][0],
          sp = highlightSpans[i][1],
          ep = highlightSpans[i][2],
          styleName = styleNames[termNames.indexOf(name)];

      for(var j = sp; j < ep; j++){
        $('#char-' + j).addClass("syntax-" + styleName);
      }
    }
    //Add CSS styles for classes
    for(var i = 0; i < styleList.length; i++){
      var content = ".syntax-" + styleList[i][1] + " { "
                  + "color: " + styleList[i][2] + ";"
                  // + "background-color: " + styleList[i][3] ? styleList[i][3] : "inherit" + ";"
                  + " }"
      var style = document.createElement('style');
      style.innerHTML = content;
      document.head.appendChild(style);
    }
  };

//JSON formatting
  function formatSpans(){
    $.each(spans, function(index, term) {
      var name = term[0],
          startPos = term[1],
          endPos = term[2],
          extraInfo = term[3],
          showName = "",
          showContent = "",
          restr = 50;
      if(name.length >= restr) showName = name.substring(0, restr) + " (...)";
      else showName = name;
      if(endPos - startPos >= restr) showContent = code.substring(startPos - 1, startPos + restr - 1) + " (...)";
      else showContent = code.substring(startPos - 1, endPos - 1)
      $('#json-table').append("<tr><td>" + showName + "</td><td>"
                                         + showContent + "</td><td>" 
                                         + " @ " + startPos + ", " + endPos + "</td></tr>")
    });
  };

//Selection
  var sortRange = function(a, b){
        var spA = a[1],
            spB = b[1],
            rgA = a[2] - a[1],
            rgB = b[2] - b[1];
        if (spA == spB) return (rgA - rgB);
        else return (spB - spA); // to make the endmost span sorted at the start of the list
      },
      findShortestRange = function(start, end){
        return spans.sort(sortRange).find(function(element){
          return (element[1] <= start) && (element[2] >= end);
        });
      };

  var selectAt = function(pos){
        var elm = findShortestRange(pos, pos);
        actionLog(code.substring(pos-1, pos) + "<b> selected @ " + pos + "</b>");
        actionLog("----------------");
        logElementInfo(elm);
      },
      selectRange = function(start, end){
        var elm = findShortestRange(start, end);
        actionLog(code.substring(start-1, end) + " <b> selected @ (" + start + "," + end + ")</b>");
        actionLog("----------------");
        logElementInfo(elm);
      };

  function showSelection() {
    var text = "",
        offset = 0,
        selection = window.getSelection(),
        start = 0,
        end = 0;

    clearLog();

    if (selection) {
        text = window.getSelection().toString();
    } else if (document.selection && document.selection.type != "Control") {
        text = document.selection.createRange().text;
    }

    if (charEnd == []){
      start = charStart[0];
      end = charStart[0];
    }
    else{
      var range = [].concat(charStart, charEnd).sort(function(a, b){return a - b;});
      end = range[range.length - 1];
      start = range[0];
    }

    charStart = []; charEnd = []; // Clear calculation

    if (end > code.length || start < 0 || (!start || !end)) { 
      clearLog();
      // actionLog("??? @ " + start + ", " + end); 
      return; 
    }
    if (end <= start) selectAt(start);
    else selectRange(start, end);
  };

//Set up hooks
  function setUpHooks(){
    function charIdToInt(id){
      return parseInt(id.substring(5));
    };
    $('#code').on('click', showSelection);
    $('.char').on('mousedown', function(){recordStartPos(charIdToInt(this.id))});
    $('.char').on('mouseup', function(){recordEndPos(charIdToInt(this.id))});
  };

//Set up all
  function setUpAll(){
    //  var positionedCode = processCode();
    makeDraggable('#h-splitter', 'x', '#container', '#code-wrapper', 'misc-wrapper');
    makeDraggable('#v-splitter', 'y', '#action-wrapper', '#json-wrapper');
    $('#code').append("<pre>" + wrapCode(code) + "</pre>");
    addHighlightStyles();
    formatSpans();
    setUpHooks();
  };

  setUpAll();

});
</script>
